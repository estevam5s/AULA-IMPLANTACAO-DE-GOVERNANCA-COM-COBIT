import React, { useState, useEffect, useRef } from 'react';
import { 
  aulasData, 
  COURSE_CONTEXT, 
  practicalExamples, 
  GEMINI_API_KEY,
  GEMINI_API_URL
} from '../data/courseData';

const Chatbot = ({ className }) => {
  const [messages, setMessages] = useState([]);
  const [inputValue, setInputValue] = useState('');
  const [isTyping, setIsTyping] = useState(false);
  const messagesEndRef = useRef(null);
  const inputRef = useRef(null);

  const chatSuggestions = [
    'O que √© COBIT?',
    'Diferen√ßa entre governan√ßa e gerenciamento',
    'Explique os 5 fundamentos do COBIT',
    'O que significa EDM no COBIT?',
    'Build vs Acquire - quando usar?',
    'Como implementar COBIT na empresa?',
    'Evolu√ß√£o hist√≥rica do COBIT',
    'Os 7 habilitadores do COBIT',
    'Efic√°cia vs Efici√™ncia',
    'Dom√≠nios APO, BAI, DSS, MEA'
  ];

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  };

  useEffect(() => {
    scrollToBottom();
  }, [messages]);

  const formatMessage = (content) => {
    let formatted = content
      .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
      .replace(/\*(.*?)\*/g, '<em>$1</em>')
      .replace(/`(.*?)`/g, '<code style="background: #f1f5f9; padding: 2px 6px; border-radius: 4px; font-family: monospace;">$1</code>')
      .replace(/\n/g, '<br>')
      .replace(/https?:\/\/[^\s]+/g, '<a href="$&" target="_blank" style="color: #3498db;">$&</a>');

    return formatted;
  };

  const addMessage = (content, sender, isError = false) => {
    const newMessage = {
      id: Date.now(),
      content,
      sender,
      timestamp: new Date().toLocaleTimeString(),
      isError
    };
    setMessages(prev => [...prev, newMessage]);
  };

  // üöÄ SISTEMA LLM MILITAR-GRADE: IA DE N√çVEL MILITAR
  const militaryGradeAI = {
    
    // üéØ AN√ÅLISE SEM√ÇNTICA PROFUNDA - N√çVEL MILITAR
    performDeepAnalysis: (question) => {
      const lowerQ = question.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
      
      const analysis = {
        intent: null,
        primaryTopic: null,
        secondaryTopics: [],
        questionType: 'general',
        complexity: 'medium',
        keywords: [],
        context: [],
        confidence: 0,
        militaryClassification: 'standard'
      };
      
      // DETEC√á√ÉO AVAN√áADA DE TIPO DE PERGUNTA
      const questionPatterns = {
        definition: /\b(o que √©|defin|conceito|significa|explique)\b/i,
        comparison: /\b(diferen√ßa|comparar|vs|versus|entre)\b/i,
        implementation: /\b(como|implementar|aplicar|usar|utilizar)\b/i,
        example: /\b(exemplo|pr√°tico|caso|situa√ß√£o|demonstra√ß√£o)\b/i,
        exercise: /\b(exerc√≠cio|quest√£o|pergunta|teste|avalia√ß√£o|quiz)\b/i,
        list: /\b(listar|liste|quais s√£o|enumere)\b/i,
        process: /\b(processo|fluxo|etapa|passo|sequ√™ncia)\b/i,
        why: /\b(por que|porque|motivo|raz√£o|justifica)\b/i,
        when: /\b(quando|em que|momento|situa√ß√£o)\b/i
      };
      
      for (const [type, pattern] of Object.entries(questionPatterns)) {
        if (pattern.test(question)) {
          analysis.questionType = type;
          analysis.confidence += 0.2;
          break;
        }
      }
      
      // MAPEAMENTO MILITAR DE T√ìPICS
      const militaryTopicClassification = {
        // SETOR ALPHA - Conceitos Fundamentais
        cobit_core: {
          keywords: ['cobit', 'framework', 'isaca', 'governan√ßa de ti'],
          classification: 'ALPHA-1',
          priority: 'HIGH'
        },
        
        // SETOR BRAVO - Efic√°cia e Efici√™ncia  
        efficiency_effectiveness: {
          keywords: ['efic√°cia', 'efici√™ncia', 'eficaz', 'eficiente', 'otimiza√ß√£o'],
          classification: 'BRAVO-1',
          priority: 'HIGH'
        },
        
        // SETOR CHARLIE - Governan√ßa vs Gerenciamento
        governance_management: {
          keywords: ['governan√ßa', 'gerenciamento', 'estrat√©gico', 'operacional', 'separa√ß√£o'],
          classification: 'CHARLIE-1',
          priority: 'CRITICAL'
        },
        
        // SETOR DELTA - Estrutura COBIT
        cobit_structure: {
          keywords: ['fundamentos', 'habilitadores', 'dom√≠nios', '5 fundamentos', '7 habilitadores'],
          classification: 'DELTA-1',
          priority: 'HIGH'
        },
        
        // SETOR ECHO - Dom√≠nios Espec√≠ficos
        domains: {
          keywords: ['edm', 'apo', 'bai', 'dss', 'mea', 'evaluate', 'direct', 'monitor', 'align', 'plan'],
          classification: 'ECHO-1',
          priority: 'HIGH'
        },
        
        // SETOR FOXTROT - Build vs Acquire
        build_acquire: {
          keywords: ['build', 'acquire', 'construir', 'adquirir', 'comprar', 'desenvolver'],
          classification: 'FOXTROT-1',
          priority: 'MEDIUM'
        },
        
        // SETOR GOLF - Exerc√≠cios e Avalia√ß√µes
        exercises: {
          keywords: ['exerc√≠cio', 'quest√£o', 'teste', 'avalia√ß√£o', 'quiz', 'pergunta'],
          classification: 'GOLF-1',
          priority: 'TACTICAL'
        },
        
        // SETOR HOTEL - Implementa√ß√£o e Pr√°tica
        implementation: {
          keywords: ['implementa√ß√£o', 'pr√°tica', 'caso pr√°tico', 'exemplo', 'aplica√ß√£o'],
          classification: 'HOTEL-1',
          priority: 'MEDIUM'
        }
      };
      
      // CLASSIFICA√á√ÉO MILITAR DE T√ìPICS
      for (const [topic, config] of Object.entries(militaryTopicClassification)) {
        const matches = config.keywords.filter(keyword => lowerQ.includes(keyword)).length;
        if (matches > 0) {
          if (!analysis.primaryTopic) {
            analysis.primaryTopic = topic;
            analysis.militaryClassification = config.classification;
          } else {
            analysis.secondaryTopics.push(topic);
          }
          analysis.confidence += matches * 0.1;
        }
      }
      
      // EXTRA√á√ÉO DE KEYWORDS MILITARES
      analysis.keywords = lowerQ.match(/\b\w{3,}\b/g) || [];
      
      // CLASSIFICA√á√ÉO DE COMPLEXIDADE
      if (analysis.confidence > 0.8) analysis.complexity = 'high';
      else if (analysis.confidence > 0.5) analysis.complexity = 'medium';
      else analysis.complexity = 'low';
      
      return analysis;
    },
    
    // ‚ú® GERADOR DE RESPOSTAS SUPER-INTELIGENTES
    generateSuperIntelligentResponse: async (question, analysis) => {
      console.log('ü§ñ Ativando IA Gemini com classifica√ß√£o militar:', analysis.militaryClassification);
      
      try {
        // CONTEXTO MILITAR ESPECIFICADO
        let militaryContext = COURSE_CONTEXT;
        
        // Adicionar conte√∫do espec√≠fico das aulas baseado na classifica√ß√£o
        const aulaContent = Object.values(aulasData)
          .map(aula => aula.content.replace(/<[^>]+>/g, ' '))
          .join('\n\n');
        militaryContext += `\n\nCONTE√öDO COMPLETO DAS AULAS:\n${aulaContent}`;
        
        // Adicionar exemplos pr√°ticos se for t√°tico
        if (analysis.militaryClassification.includes('GOLF') || analysis.questionType === 'exercise') {
          militaryContext += `\n\nEXEMPLOS PR√ÅTICOS DISPON√çVEIS:\n${JSON.stringify(practicalExamples, null, 2)}`;
        }
        
        // PROMPT MILITAR-GRADE OTIMIZADO
        const militaryPrompt = `
        üöÄ OPERA√á√ÉO: RESPOSTA INTELIGENTE COBIT
        CLASSIFICA√á√ÉO: ${analysis.militaryClassification}
        
        ${militaryContext}
        
        === BRIEFING DA MISS√ÉO ===
        PERGUNTA DO ESTUDANTE: "${question}"
        
        AN√ÅLISE T√ÅTICA:
        - Tipo de pergunta: ${analysis.questionType}
        - T√≥pico prim√°rio: ${analysis.primaryTopic}
        - N√≠vel de confian√ßa: ${(analysis.confidence * 100).toFixed(0)}%
        - Complexidade: ${analysis.complexity}
        
        === OBJETIVOS DA MISS√ÉO ===
        ${militaryGradeAI.getMissionObjectives(analysis.questionType, analysis.primaryTopic)}
        
        === REGRAS DE ENGAJAMENTO ===
        1. üéØ Resposta PRECISA baseada EXCLUSIVAMENTE no conte√∫do das aulas
        2. üìö Use formata√ß√£o markdown profissional
        3. üí° Inclua exemplos pr√°ticos quando relevante
        4. üöÄ Seja did√°tico mas inteligente
        5. ‚úÖ Se for exerc√≠cio, gere quest√µes inteligentes e variadas
        6. üß† Demonstre conhecimento profundo dos conceitos
        7. üéØ Se n√£o souber, seja honesto mas ofere√ßa alternativas
        
        RESPOSTA (m√°ximo 600 palavras):
        `;
        
        const response = await fetch(GEMINI_API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-goog-api-key': GEMINI_API_KEY
          },
          body: JSON.stringify({
            contents: [{
              parts: [{ text: militaryPrompt }]
            }],
            generationConfig: {
              temperature: 0.4, // Balanceado para precis√£o e criatividade
              topK: 30,
              topP: 0.85,
              maxOutputTokens: 1200
            }
          })
        });
        
        if (!response.ok) {
          throw new Error(`API Error: ${response.status} - ${response.statusText}`);
        }
        
        const data = await response.json();
        const aiResponse = data.candidates?.[0]?.content?.parts?.[0]?.text;
        
        if (aiResponse && aiResponse.trim().length > 50) {
          console.log('‚úÖ IA militar respondeu com sucesso');
          return aiResponse.trim();
        } else {
          throw new Error('Resposta da IA muito curta ou inv√°lida');
        }
        
      } catch (error) {
        console.error('‚ö†Ô∏è Falha na IA Gemini:', error);
        throw error;
      }
    },
    
    // üéØ SISTEMA T√ÅTICO DE BACKUP (MUITO MAIS INTELIGENTE)
    tacticalFallbackSystem: (question) => {
      console.log('üõ°Ô∏è Ativando sistema t√°tico de backup');
      
      const analysis = militaryGradeAI.performDeepAnalysis(question);
      const lowerQ = question.toLowerCase();
      
      // BANCO DE CONHECIMENTO T√ÅTICO
      const tacticalKnowledge = militaryGradeAI.getTacticalKnowledge();
      
      // PROCESSAMENTO INTELIGENTE BASEADO NA CLASSIFICA√á√ÉO
      if (analysis.primaryTopic) {
        return militaryGradeAI.generateTacticalResponse(analysis, tacticalKnowledge);
      }
      
      // DETEC√á√ÉO AVAN√áADA DE EXERC√çCIOS
      if (lowerQ.includes('exerc') || lowerQ.includes('quest') || lowerQ.includes('teste') || lowerQ.includes('aula')) {
        return militaryGradeAI.generateExerciseResponse(question, analysis);
      }
      
      // RESPOSTA INTELIGENTE PADR√ÉO
      return militaryGradeAI.generateIntelligentFallback(question, analysis);
    },
    
    // GERADOR DE OBJETIVOS DE MISS√ÉO
    getMissionObjectives: (questionType, primaryTopic) => {
      const objectives = {
        definition: 'Fornecer defini√ß√£o clara, precisa e did√°tica',
        comparison: 'Explicar diferen√ßas com tabela comparativa detalhada',
        implementation: 'Dar passos pr√°ticos de implementa√ß√£o',
        exercise: 'Gerar exerc√≠cios inteligentes e educativos',
        example: 'Fornecer exemplos pr√°ticos relevantes',
        list: 'Criar lista organizada e completa',
        process: 'Detalhar processo passo-a-passo'
      };
      
      return objectives[questionType] || 'Fornecer resposta completa e educativa';
    },
    
    // üß† BANCO DE CONHECIMENTO T√ÅTICO
    getTacticalKnowledge: () => ({
      cobit_core: {
        definition: 'O COBIT (Control Objectives for Information and Related Technologies) √© um framework de governan√ßa e gest√£o de TI criado pela ISACA.',
        evolution: 'üìà Evolu√ß√£o Hist√≥rica:\n‚Ä¢ 1996: Auditoria de sistemas\n‚Ä¢ 2005: COBIT 4.0 - Primeira men√ß√£o √† governan√ßa\n‚Ä¢ **2012: COBIT 5 - REVOLU√á√ÉO** - Integra√ß√£o com governan√ßa corporativa\n‚Ä¢ 2019: COBIT 2019 - Era digital',
        objective: 'Ajudar organiza√ß√µes a atingir objetivos atrav√©s de governan√ßa e gerenciamento eficaz de TI'
      },
      
      efficiency_effectiveness: {
        definition: 'üéØ **EFIC√ÅCIA vs EFICI√äNCIA - Diferen√ßa Fundamental**\n\n**EFIC√ÅCIA:** Fazer a coisa certa (cumprir fun√ß√µes)\n**EFICI√äNCIA:** Fazer certo (otimizar recursos)\n\n**Exemplo Pr√°tico:** Sistema de folha - EFICAZ se funciona, EFICIENTE se custa menos que processo manual\n\n**Regra de Ouro:** Primeiro efic√°cia, depois efici√™ncia!',
      },
      
      governance_management: {
        definition: 'üìä **GOVERNAN√áA vs GERENCIAMENTO**\n\n| Aspecto | Governan√ßa | Gerenciamento |\n|---------|-------------|---------------|\n| **N√≠vel** | Estrat√©gico | Operacional |\n| **Fun√ß√£o** | Define "O QUE" | Define "COMO" |\n| **Horizonte** | Longo prazo | Curto/m√©dio prazo |\n| **Respons√°vel** | Conselho/Diretoria | Executivos/Gestores |\n\n**Exemplo:** Governan√ßa aprova R$ 2M para e-commerce. Gerenciamento escolhe Shopify e implementa.'
      },
      
      cobit_structure: {
        fundamentos: 'üèõÔ∏è **OS 5 FUNDAMENTOS DO COBIT:**\n\n**1.** Atender necessidades das partes interessadas\n**2.** Cobertura hol√≠stica (TI √© pervasiva)\n**3.** Estrutura integrada (framework √∫nico)\n**4.** Abordagem hol√≠stica (sistema integrado)\n**5.** Separar governan√ßa de gerenciamento\n\n*Base conceitual que sustenta toda arquitetura COBIT*',
        
        habilitadores: 'üîß **OS 7 HABILITADORES DO COBIT:**\n\n**ESTRUTURAIS (4):**\n1. Princ√≠pios, Pol√≠ticas e Modelos\n2. Processos\n3. Estruturas Organizacionais\n4. Cultura, √âtica e Comportamento\n\n**RECURSOS (3):**\n5. **Informa√ß√£o** (recurso mais valioso)\n6. Servi√ßos, Infraestrutura e Aplicativos\n7. Pessoas, Habilidades e Compet√™ncias'
      },
      
      domains: {
        overview: '‚öôÔ∏è **OS 5 DOM√çNIOS DO COBIT:**\n\nüëë **GOVERNAN√áA (1):** EDM\nüîß **GERENCIAMENTO (4):** APO, BAI, DSS, MEA\n\n**Fluxo Estrat√©gico:**\nEDM define ‚Üí APO planeja ‚Üí BAI implementa ‚Üí DSS opera ‚Üí MEA monitora ‚Üí realimenta EDM',
        
        edm: '**EDM - Evaluate, Direct, Monitor**\n‚Ä¢ √önico dom√≠nio de governan√ßa\n‚Ä¢ 5 processos\n‚Ä¢ Responsabilidade: Conselho/Alta Dire√ß√£o',
        apo: '**APO - Align, Plan, Organise**\n‚Ä¢ Planejamento estrat√©gico de TI\n‚Ä¢ Identifica como TI contribui para objetivos',
        bai: '**BAI - Build, Acquire, Implement**\n‚Ä¢ **FILOSOFIA: SEMPRE PRIORIZAR AQUISI√á√ÉO**\n‚Ä¢ Comprar solu√ß√µes prontas do mercado',
        dss: '**DSS - Deliver, Service, Support**\n‚Ä¢ Dia a dia da TI\n‚Ä¢ Opera√ß√£o de solu√ß√µes implementadas',
        mea: '**MEA - Monitor, Evaluate, Assess**\n‚Ä¢ Qualidade e conformidade\n‚Ä¢ Alimenta EDM com informa√ß√µes estrat√©gicas'
      },
      
      build_acquire: {
        definition: 'üèóÔ∏è **BUILD vs ACQUIRE - Regra de Ouro**\n\n‚úÖ **SEMPRE PRIORIZAR AQUISI√á√ÉO (ACQUIRE)**\n\n**Por qu√™ Acquire?**\n‚Ä¢ Time to Market: Semanas vs Anos\n‚Ä¢ Custo: Previs√≠vel vs Imprevis√≠vel\n‚Ä¢ Manuten√ß√£o: Fornecedor vs Empresa\n‚Ä¢ Expertise: Mercado vs Interna\n\n**Quando Build?**\n‚Ä¢ N√£o existe no mercado\n‚Ä¢ Diferencial competitivo\n‚Ä¢ Necessidades muito espec√≠ficas\n\n**Exemplo:** CRM - Salesforce (2-3 meses) vs Desenvolvimento (12-18 meses)'
      }
    }),
    
    // üéØ GERADOR DE RESPOSTA T√ÅTICA
    generateTacticalResponse: (analysis, knowledge) => {
      const topic = analysis.primaryTopic;
      const questionType = analysis.questionType;
      
      console.log(`üéØ Gerando resposta t√°tica para: ${topic} (${questionType})`);
      
      let response = `**üöÄ Assistente Militar COBIT** - Classifica√ß√£o: ${analysis.militaryClassification}\n\n`;
      
      switch (topic) {
        case 'cobit_core':
          if (questionType === 'definition') {
            response += knowledge.cobit_core.definition + '\n\n' + knowledge.cobit_core.objective;
          } else if (questionType === 'example') {
            response += knowledge.cobit_core.evolution;
          } else {
            response += knowledge.cobit_core.definition + '\n\n**Evolu√ß√£o:**\n' + knowledge.cobit_core.evolution;
          }
          break;
          
        case 'efficiency_effectiveness':
          response += knowledge.efficiency_effectiveness.definition;
          break;
          
        case 'governance_management':
          response += knowledge.governance_management.definition;
          break;
          
        case 'cobit_structure':
          if (analysis.keywords.includes('fundamentos')) {
            response += knowledge.cobit_structure.fundamentos;
          } else if (analysis.keywords.includes('habilitadores')) {
            response += knowledge.cobit_structure.habilitadores;
          } else {
            response += knowledge.cobit_structure.fundamentos + '\n\n' + knowledge.cobit_structure.habilitadores;
          }
          break;
          
        case 'domains':
          if (analysis.keywords.some(k => ['edm', 'evaluate'].includes(k))) {
            response += knowledge.domains.edm;
          } else if (analysis.keywords.some(k => ['apo', 'align'].includes(k))) {
            response += knowledge.domains.apo;
          } else if (analysis.keywords.some(k => ['bai', 'build', 'acquire'].includes(k))) {
            response += knowledge.domains.bai;
          } else if (analysis.keywords.some(k => ['dss', 'deliver'].includes(k))) {
            response += knowledge.domains.dss;
          } else if (analysis.keywords.some(k => ['mea', 'monitor'].includes(k))) {
            response += knowledge.domains.mea;
          } else {
            response += knowledge.domains.overview;
          }
          break;
          
        case 'build_acquire':
          response += knowledge.build_acquire.definition;
          break;
          
        default:
          response += 'T√≥pico identificado mas aguardando classifica√ß√£o especial. Reformule a pergunta para melhor precis√£o.';
      }
      
      return response;
    },
    
    // üìù GERADOR DE EXERC√çCIOS INTELIGENTES
    generateExerciseResponse: (question, analysis) => {
      console.log('üìù Gerando exerc√≠cios inteligentes');
      
      const lowerQ = question.toLowerCase();
      let targetAula = '';
      
      if (lowerQ.includes('aula 1') || lowerQ.includes('aula 01')) {
        targetAula = 'Aula 01';
      } else if (lowerQ.includes('aula 2') || lowerQ.includes('aula 02')) {
        targetAula = 'Aula 02';
      }
      
      return `**üéØ Exerc√≠cios Inteligentes COBIT** ${targetAula ? `- ${targetAula}` : ''}\n\n` +
        `üöÄ **Sistema de Gera√ß√£o Ativo!**\n\n` +
        militaryGradeAI.getPreBuiltExercises(targetAula) +
        '\n\nüí° **Quer exerc√≠cios personalizados?** Especifique o t√≥pico:\n' +
        '‚Ä¢ "Exerc√≠cios sobre efic√°cia vs efici√™ncia"\n' +
        '‚Ä¢ "Quest√µes sobre os 5 dom√≠nios"\n' +
        '‚Ä¢ "Teste sobre Build vs Acquire"';
    },
    
    // üìã EXERC√çCIOS PR√â-CONSTRU√çDOS
    getPreBuiltExercises: (aula) => {
      const exercises = {
        'Aula 01': `üìò **EXERC√çCIOS AULA 01 - Conceitos Fundamentais**\n\n` +
          `**Quest√£o 1:** Qual a principal diferen√ßa entre efic√°cia e efici√™ncia?\n` +
          `a) N√£o h√° diferen√ßa\nb) Efic√°cia √© fazer certo, efici√™ncia √© fazer r√°pido\nc) ‚úÖ Efic√°cia √© cumprir fun√ß√µes, efici√™ncia √© otimizar recursos\nd) Efici√™ncia √© mais importante\n\n` +
          `**Quest√£o 2:** Quantos fundamentos tem o COBIT?\n` +
          `a) 3\nb) ‚úÖ 5\nc) 7\nd) 10\n\n` +
          `**Quest√£o 3:** O que foi revolucion√°rio no COBIT 5 (2012)?\n` +
          `a) Foco em auditoria\nb) ‚úÖ Integra√ß√£o com governan√ßa corporativa\nc) Cria√ß√£o dos dom√≠nios\nd) Foco em TI apenas`,
          
        'Aula 02': `üìó **EXERC√çCIOS AULA 02 - Estrutura e Dom√≠nios**\n\n` +
          `**Quest√£o 1:** Quantos dom√≠nios tem o COBIT e qual √© de governan√ßa?\n` +
          `a) 4 dom√≠nios, APO √© governan√ßa\nb) ‚úÖ 5 dom√≠nios, EDM √© governan√ßa\nc) 6 dom√≠nios, MEA √© governan√ßa\nd) 3 dom√≠nios, DSS √© governan√ßa\n\n` +
          `**Quest√£o 2:** Qual a regra para Build vs Acquire?\n` +
          `a) Sempre construir internamente\nb) ‚úÖ Sempre priorizar aquisi√ß√£o\nc) Depende do or√ßamento\nd) N√£o h√° regra\n\n` +
          `**Quest√£o 3:** O que significa EDM?\n` +
          `a) Execute, Deploy, Manage\nb) ‚úÖ Evaluate, Direct, Monitor\nc) Establish, Define, Measure\nd) Enable, Develop, Maintain`
      };
      
      if (aula && exercises[aula]) {
        return exercises[aula];
      }
      
      return `üéØ **EXERC√çCIOS GERAIS COBIT**\n\n` +
        `**üî• Quest√£o R√°pida:** O que √© mais importante: efic√°cia ou efici√™ncia?\n` +
        `**Resposta:** Efic√°cia primeiro! N√£o adianta fazer errado muito bem feito.\n\n` +
        `**üìä Quest√£o Estrat√©gica:** Quantos dom√≠nios de governan√ßa tem o COBIT?\n` +
        `**Resposta:** Apenas 1 - EDM (Evaluate, Direct, Monitor)`;
    },
    
    // üöÄ GERADOR DE RESPOSTA INTELIGENTE PADR√ÉO
    generateIntelligentFallback: (question, analysis) => {
      const lowerQ = question.toLowerCase();
      
      // DETEC√á√ÉO AVAN√áADA DE INTEN√á√ïES
      if (lowerQ.includes('exerc') || lowerQ.includes('quest') || lowerQ.includes('teste')) {
        return militaryGradeAI.generateExerciseResponse(question, analysis);
      }
      
      if (lowerQ.includes('exemplo') || lowerQ.includes('pr√°tico') || lowerQ.includes('caso')) {
        return `**üí° Exemplo Pr√°tico COBIT**\n\n` +
          `üè¢ **Cen√°rio:** Banco quer reduzir falhas em projetos TI\n\n` +
          `**Antes:** 70% falha, custos altos, baixa satisfa√ß√£o\n\n` +
          `**Implementa√ß√£o COBIT:**\n` +
          `‚Ä¢ **EDM:** Criou Comit√™ Governan√ßa TI\n` +
          `‚Ä¢ **APO:** Implementou gest√£o portf√≥lio\n` +
          `‚Ä¢ **BAI:** Padronizou desenvolvimento\n` +
          `‚Ä¢ **DSS:** Melhorou service desk\n` +
          `‚Ä¢ **MEA:** Auditoria cont√≠nua\n\n` +
          `**Resultado:** 90% sucesso, -25% custos, 85% satisfa√ß√£o \n\n` +
          `üéØ Este √© o poder do COBIT em a√ß√£o!`;
      }
      
      if (lowerQ.includes('vantagem') || lowerQ.includes('beneficio') || lowerQ.includes('por que usar')) {
        return `**üöÄ Por que usar COBIT?**\n\n` +
          `**Para Organiza√ß√£o:**\n` +
          `‚Ä¢ üéØ Alinhamento TI-Neg√≥cios\n` +
          `‚Ä¢ üí∞ Otimiza√ß√£o investimentos\n` +
          `‚Ä¢ üõ°Ô∏è Gest√£o de riscos\n` +
          `‚Ä¢ üß† Melhores decis√µes\n\n` +
          `**Para Profissionais:**\n` +
          `‚Ä¢ üìö Base s√≥lida carreira\n` +
          `‚Ä¢ üåç Reconhecimento global\n` +
          `‚Ä¢ üîç Prepara√ß√£o auditoria\n` +
          `‚Ä¢ üöÄ Vis√£o estrat√©gica TI`;
      }
      
      // RESPOSTA INTELIGENTE PERSONALIZADA
      return `**ü§ñ Assistente Militar COBIT** - An√°lise: ${analysis.complexity.toUpperCase()}\n\n` +
        `üìä **Pergunta identificada com ${(analysis.confidence * 100).toFixed(0)}% de confian√ßa**\n\n` +
        `üéØ **Posso ajudar especificamente com:**\n\n` +
        `üìò **Aula 01 - Fundamentos:**\n` +
        `‚Ä¢ Efic√°cia vs Efici√™ncia\n‚Ä¢ 5 Fundamentos COBIT\n‚Ä¢ 7 Habilitadores\n‚Ä¢ Evolu√ß√£o hist√≥rica\n\n` +
        `üìó **Aula 02 - Estrutura:**\n` +
        `‚Ä¢ Governan√ßa vs Gerenciamento\n‚Ä¢ 5 Dom√≠nios (EDM, APO, BAI, DSS, MEA)\n‚Ä¢ Build vs Acquire\n‚Ä¢ Implementa√ß√£o pr√°tica\n\n` +
        `üìù **Gera√ß√£o de Conte√∫do:**\n` +
        `‚Ä¢ Exerc√≠cios inteligentes\n‚Ä¢ Casos pr√°ticos\n‚Ä¢ Compara√ß√µes detalhadas\n‚Ä¢ Implementa√ß√£o passo-a-passo\n\n` +
        `üöÄ **Reformule sua pergunta** ou escolha um t√≥pico espec√≠fico para resposta militar-grade!`;
    }
  };

  // Sistema de IA melhorado para processar perguntas
  // üöÄ SISTEMA LLM MILITAR-GRADE - M√ÅXIMA INTELIG√äNCIA
  const processQuestion = async (question) => {
    console.log('üó°Ô∏è Processando pergunta com IA militar-grade:', question);
    
    try {
      // FASE 1: An√°lise sem√¢ntica avan√ßada
      const deepAnalysis = militaryGradeAI.performDeepAnalysis(question);
      console.log('üéØ An√°lise profunda:', deepAnalysis);
      
      // FASE 2: Gera√ß√£o inteligente com Gemini AI
      const aiResponse = await militaryGradeAI.generateSuperIntelligentResponse(question, deepAnalysis);
      console.log('‚ú® Resposta da IA:', aiResponse ? 'Sucesso' : 'Falhou');
      
      if (aiResponse && aiResponse.length > 50) {
        return aiResponse;
      }
      
      throw new Error('Resposta da IA insuficiente');
      
    } catch (error) {
      console.error('‚ö†Ô∏è Erro na IA militar, ativando sistema t√°tico:', error);
      
      // SISTEMA T√ÅTICO DE BACKUP: Muito mais inteligente que o anterior
      return militaryGradeAI.tacticalFallbackSystem(question);
    }
  };

  const sendMessage = async () => {
    const message = inputValue.trim();
    if (!message) return;

    setInputValue('');
    addMessage(message, 'user');
    setIsTyping(true);

    try {
      // Processamento ass√≠ncrono com IA militar-grade
      console.log('üöÄ Iniciando processamento militar-grade...');
      const response = await processQuestion(message);
      setIsTyping(false);
      addMessage(response, 'assistant');
      console.log('‚úÖ Resposta entregue com sucesso');
    } catch (error) {
      console.error('‚ùå Erro cr√≠tico no processamento:', error);
      setIsTyping(false);
      addMessage(
        '‚ö†Ô∏è **Sistema em Manuten√ß√£o T√°tica**\n\nOcorreu um erro inesperado no sistema militar-grade. O assistente est√° sendo otimizado para m√°xima performance.\n\nüîß **Tente novamente** ou reformule sua pergunta.\n\n*Sistema de backup ativo e funcionando!*',
        'assistant',
        true
      );
    }
  };

  const sendSuggestion = (suggestion) => {
    setInputValue(suggestion);
    inputRef.current?.focus();
  };

  const handleKeyDown = (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  };

  const handleInputChange = (e) => {
    setInputValue(e.target.value);
    e.target.style.height = 'auto';
    e.target.style.height = Math.min(e.target.scrollHeight, 120) + 'px';
  };

  return (
    <div className={className || "content-section"}>
      <div className="section-title">ü§ñ Assistente de IA - Professor Virtual COBIT</div>
      
      <div className="chat-container">
        <div className="chat-header">
          <h3>Assistant Virtual de Governan√ßa</h3>
          <div className="chat-status">
            <span>IA avan√ßada com todo o conhecimento das aulas COBIT!</span>
          </div>
        </div>

        <div className="chat-messages">
          {messages.length === 0 ? (
            <div className="welcome-message">
              <h4>üëã Ol√°! Sou seu Professor Virtual de COBIT</h4>
              <p>Tenho conhecimento completo das <strong>Aulas 01 e 02</strong> e posso ajudar com qualquer conceito, exemplo pr√°tico ou d√∫vida sobre:</p>
              
              <div style={{ textAlign: 'left', margin: '20px 0', maxWidth: '600px' }}>
                <p><strong>üìö Conceitos Fundamentais:</strong> Efic√°cia vs Efici√™ncia, Controle Interno, Frameworks</p>
                <p><strong>üèõÔ∏è Fundamentos:</strong> Os 5 Fundamentos e 7 Habilitadores do COBIT</p>
                <p><strong>‚öôÔ∏è Dom√≠nios:</strong> EDM, APO, BAI, DSS, MEA - fun√ß√£o de cada um</p>
                <p><strong>üèóÔ∏è Boas Pr√°ticas:</strong> Build vs Acquire, implementa√ß√£o pr√°tica</p>
                <p><strong>üìà Evolu√ß√£o:</strong> Hist√≥ria do COBIT, marcos importantes</p>
              </div>

              <div className="chat-suggestions">
                {chatSuggestions.map((suggestion, index) => (
                  <div
                    key={index}
                    className="suggestion-chip"
                    onClick={() => sendSuggestion(suggestion)}
                  >
                    {suggestion}
                  </div>
                ))}
              </div>
            </div>
          ) : (
            messages.map((message) => (
              <div key={message.id} className={`message ${message.sender}`}>
                <div className="message-avatar">
                  {message.sender === 'user' ? 'üë§' : 'ü§ñ'}
                </div>
                <div>
                  <div
                    className={`message-content ${message.isError ? 'error-message' : ''}`}
                    dangerouslySetInnerHTML={{ __html: formatMessage(message.content) }}
                  />
                  <div className="message-time">{message.timestamp}</div>
                </div>
              </div>
            ))
          )}

          {isTyping && (
            <div className="typing-indicator" style={{ display: 'block' }}>
              <div className="typing-dots">
                <span></span>
                <span></span>
                <span></span>
              </div>
            </div>
          )}
          
          <div ref={messagesEndRef} />
        </div>

        <div className="chat-input-container">
          <div className="chat-input-wrapper">
            <textarea
              ref={inputRef}
              className="chat-input"
              placeholder="Pergunte qualquer coisa sobre COBIT, governan√ßa, dom√≠nios, exemplos pr√°ticos..."
              value={inputValue}
              onChange={handleInputChange}
              onKeyDown={handleKeyDown}
              rows="1"
            />
            <button
              className="chat-send-btn"
              onClick={sendMessage}
              disabled={!inputValue.trim() || isTyping}
            >
              <span>‚û§</span>
            </button>
          </div>
        </div>
      </div>

      <div className="ai-info-panel">
        <div className="ai-panel-header">
          <h4>üöÄ Sistema IA Avan√ßado Ativo</h4>
          <div className="ai-status-badge">ONLINE</div>
        </div>
        
        <div className="ai-capabilities">
          <div className="capability-item">
            <span className="capability-icon">üß†</span>
            <div>
              <strong>IA Generativa Avan√ßada</strong>
              <p>Powered by Google Gemini com an√°lise sem√¢ntica</p>
            </div>
          </div>
          
          <div className="capability-item">
            <span className="capability-icon">üìä</span>
            <div>
              <strong>Base de Conhecimento Completa</strong>
              <p>Todas as aulas do Prof. Eder Jos√© Cassimiro integradas</p>
            </div>
          </div>
          
          <div className="capability-item">
            <span className="capability-icon">‚ö°</span>
            <div>
              <strong>Processamento Inteligente</strong>
              <p>An√°lise contextual e respostas personalizadas</p>
            </div>
          </div>
          
          <div className="capability-item">
            <span className="capability-icon">üéØ</span>
            <div>
              <strong>Precis√£o Cient√≠fica</strong>
              <p>Respostas baseadas exclusivamente no conte√∫do das aulas</p>
            </div>
          </div>
        </div>
        
        <div className="performance-metrics">
          <div className="metric">
            <span className="metric-value">100%</span>
            <span className="metric-label">Cobertura das Aulas</span>
          </div>
          <div className="metric">
            <span className="metric-value">AI+</span>
            <span className="metric-label">Tecnologia</span>
          </div>
          <div className="metric">
            <span className="metric-value">24/7</span>
            <span className="metric-label">Disponibilidade</span>
          </div>
        </div>
      </div>
    </div>
  );
};

export default Chatbot;